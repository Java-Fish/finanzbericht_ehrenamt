name: ğŸ—ï¸ Build Apps for All Platforms

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Manueller Trigger

jobs:
  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ§ª Run Tests
      run: |
        python test/fast_test_runner.py

  build:
    name: ğŸ—ï¸ Build Apps
    needs: test
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows
            executable_name: "Finanzauswertung_Ehrenamt.exe"
            icon_ext: "ico"
            
          - os: macos-latest  
            platform: macos
            executable_name: "Finanzauswertung_Ehrenamt.app"
            icon_ext: "icns"
            
          - os: ubuntu-latest
            platform: linux
            executable_name: "Finanzauswertung_Ehrenamt"
            icon_ext: "png"

    runs-on: ${{ matrix.os }}

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: ğŸ¨ Install Icon Tools (macOS)
      if: matrix.platform == 'macos'
      run: |
        pip install icnsutil

    - name: ğŸ¨ Install Icon Tools (Windows/Linux) 
      if: matrix.platform != 'macos'
      run: |
        pip install Pillow

    - name: ğŸ—ï¸ Build Application
      run: |
        python build.py

    - name: ğŸ“ Create Release Info
      shell: bash
      run: |
        echo "# ğŸ“Š Finanzauswertung Ehrenamt" > release_info.md
        echo "**Version:** 1.0.0" >> release_info.md
        echo "**Build-Datum:** $(date '+%d.%m.%Y %H:%M:%S')" >> release_info.md  
        echo "**Plattform:** ${{ matrix.platform }}" >> release_info.md
        echo "**Python:** $(python --version)" >> release_info.md
        echo "" >> release_info.md
        echo "## âœ¨ Features" >> release_info.md
        echo "- BWA-PDF-Generierung" >> release_info.md
        echo "- CSV/Excel/ODS Import" >> release_info.md
        echo "- Quartalsauswertungen" >> release_info.md
        echo "- Sachkonto-Mapping" >> release_info.md

    - name: ğŸ“¦ Prepare Artifacts
      shell: bash
      run: |
        mkdir -p artifacts
        if [ -d "build" ]; then
          cp -r build/* artifacts/ 2>/dev/null || true
        fi
        cp release_info.md artifacts/ 2>/dev/null || true
        
        # Zeige was gebaut wurde
        echo "ğŸ” Build-Ergebnisse:"
        find artifacts -type f -name "*" | head -20

    - name: â¬†ï¸ Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: finanzauswertung-${{ matrix.platform }}
        path: artifacts/
        retention-days: 30

    - name: ğŸ·ï¸ Create Release (Tags only)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/*
        name: "Finanzauswertung Ehrenamt ${{ github.ref_name }}"
        body_path: artifacts/release_info.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Benachrichtigung bei erfolgreichem Build
  notify:
    name: ğŸ“¢ Build Notification
    needs: [test, build]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: âœ… Success Notification
      if: needs.build.result == 'success'
      run: |
        echo "ğŸ‰ Alle Builds erfolgreich!"
        echo "ğŸ“± Apps fÃ¼r Windows, macOS und Linux erstellt"
        
    - name: âŒ Failure Notification  
      if: needs.build.result == 'failure'
      run: |
        echo "âŒ Build fehlgeschlagen"
        echo "ğŸ” Siehe Build-Logs fÃ¼r Details"
