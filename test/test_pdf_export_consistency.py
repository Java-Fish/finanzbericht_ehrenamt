#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Test f√ºr BWA-PDF-Export - Erweiterte Tests f√ºr Spalten-Konsistenz
"""

import sys
import os
import tempfile
import json
import pandas as pd
from pathlib import Path
from PySide6.QtWidgets import QApplication
from PySide6.QtCore import QSettings

# Lokale Imports - Pfad zum Projekt-Root hinzuf√ºgen
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))
from src.utils.bwa_generator import BWAPDFGenerator
from src.utils.csv_processor import CSVProcessor
from test_helpers import TestFileManager


def test_pdf_cover_page_with_organization():
    """Testet die Deckblatt-Generierung mit Organisationsdaten"""
    print("üìÑ Teste PDF-Deckblatt mit Organisationsdaten...")
    
    file_manager = TestFileManager()
    
    try:
        # Test-Organisationsdaten in Settings speichern
        settings = QSettings()
        settings.setValue("organization/name", "Musterverein e.V.")
        settings.setValue("organization/street", "Musterstra√üe 123")
        settings.setValue("organization/zip", "12345")
        settings.setValue("organization/city", "Musterstadt")
        settings.setValue("organization/phone", "+49 123 456789")
        settings.setValue("organization/email", "info@musterverein.de")
        settings.setValue("organization/info", "Ein Verein f√ºr alle F√§lle")
        settings.setValue("opening_balance", 1000.0)
        
        # Test-CSV-Daten erstellen
        test_csv_content = """Sachkontonr.;Betrag;Buchungstag;Beschreibung;Verwendungszweck
4000;1.500,00;2024-01-15;Mitgliedsbeitr√§ge;Jahresbeitrag M√ºller
4100;500,00;2024-02-10;Spenden;Spende Schmidt"""
        
        test_csv_path = file_manager.get_temp_file_path('test_org.csv')
        with open(test_csv_path, 'w', encoding='utf-8') as f:
            f.write(test_csv_content)
        
        # CSV-Processor und BWA-Generator
        csv_processor = CSVProcessor()
        success_load = csv_processor.load_file(test_csv_path)
        
        if not success_load:
            print("‚ùå CSV-Datei konnte nicht geladen werden")
            return False
        
        generator = BWAPDFGenerator()
        
        # Test der Deckblatt-Erstellung
        cover_elements = generator._create_cover_page(csv_processor)
        
        if not cover_elements:
            print("‚ùå Deckblatt-Elemente konnten nicht erstellt werden")
            return False
            
        print(f"‚úÖ Deckblatt erstellt mit {len(cover_elements)} Elementen")
        
        # Test der vollst√§ndigen PDF-Generierung mit Organisationsdaten
        output_pdf = file_manager.get_temp_file_path('test_org_output.pdf')
        account_mappings = {
            "4000": "Mitgliedsbeitr√§ge",
            "4100": "Spenden"
        }
        
        # Settings f√ºr minimale PDF-Generierung (nur Deckblatt und Jahr)
        settings.setValue("generate_quarterly_reports", False)
        settings.setValue("generate_account_reports", False)
        settings.setValue("generate_chart_report", False)
        
        success = generator.generate_bwa_pdf(output_pdf, csv_processor, account_mappings)
        
        if success and os.path.exists(output_pdf):
            file_size = os.path.getsize(output_pdf)
            print(f"‚úÖ PDF mit Organisationsdaten erstellt!")
            print(f"   üìÑ Gr√∂√üe: {file_size:,} Bytes")
            
            if file_size > 2000:
                print("‚úÖ PDF hat angemessene Gr√∂√üe f√ºr Organisationsdaten")
            else:
                print("‚ö†Ô∏è PDF kleiner als erwartet")
                
        else:
            print("‚ùå PDF-Generierung mit Organisationsdaten fehlgeschlagen")
            return False
        
        # Settings zur√ºcksetzen
        settings.remove("organization/name")
        settings.remove("organization/street")
        settings.remove("organization/zip")
        settings.remove("organization/city")
        settings.remove("organization/phone")
        settings.remove("organization/email")
        settings.remove("organization/info")
        settings.remove("generate_quarterly_reports")
        settings.remove("generate_account_reports")
        settings.remove("generate_chart_report")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Fehler beim Organisationsdaten-Test: {e}")
        import traceback
        traceback.print_exc()
        return False


def test_pdf_export_consistency():
    """Testet die Konsistenz zwischen Betrag und Betrag_Clean Spalten beim PDF-Export"""
    print("üìä Teste PDF-Export mit Spalten-Konsistenz...")
    
    file_manager = TestFileManager()
    
    try:
        # Test-CSV-Daten mit verschiedenen Betragsformaten erstellen
        test_csv_content = """Sachkontonr.;Betrag;Buchungstag;Beschreibung;Verwendungszweck
4000;1.500,00;2024-01-15;Mitgliedsbeitr√§ge;Jahresbeitrag M√ºller
4100;2000.50;2024-02-10;Spenden;Spende Schmidt
6300;-450,00;2024-01-20;B√ºrokosten;B√ºromaterial
6400;-800.75;2024-03-05;Miete;Monatsmiete M√§rz
8100;-320,50;2024-04-15;Veranstaltungskosten;Catering Event
4000;500,00;2024-05-10;Mitgliedsbeitr√§ge;Nachzahlung"""
        
        # Test-CSV-Datei erstellen
        test_csv_path = file_manager.get_temp_file_path('test_consistency.csv')
        with open(test_csv_path, 'w', encoding='utf-8') as f:
            f.write(test_csv_content)
        
        # CSV-Processor initialisieren und Datei laden
        csv_processor = CSVProcessor()
        success_load = csv_processor.load_file(test_csv_path)
        
        if not success_load:
            print("‚ùå CSV-Datei konnte nicht geladen werden")
            return False
        
        # Test 1: Pr√ºfe ob Betrag_Clean Spalte erstellt wurde
        processed_data = csv_processor.processed_data
        if processed_data is None or processed_data.empty:
            print("‚ùå Keine verarbeiteten Daten verf√ºgbar")
            return False
            
        if 'Betrag_Clean' not in processed_data.columns:
            print("‚ùå Betrag_Clean Spalte wurde nicht erstellt")
            return False
        
        print("‚úÖ Betrag_Clean Spalte vorhanden")
        
        # Test 2: Pr√ºfe Datentypen und Werte
        betrag_clean_series = processed_data['Betrag_Clean']
        if not betrag_clean_series.dtype in ['float64', 'float32']:
            print(f"‚ùå Betrag_Clean hat falschen Datentyp: {betrag_clean_series.dtype}")
            return False
            
        print("‚úÖ Betrag_Clean hat korrekten Datentyp (float)")
        
        # Test 3: BWA-Generator Methoden testen
        generator = BWAPDFGenerator()
        
        # Test _calculate_total_amount
        total_amount = generator._calculate_total_amount(csv_processor)
        print(f"‚ÑπÔ∏è Gesamtsumme berechnet: {total_amount:.2f}")
        
        # Test Quartals-Berechnung
        quarter_data = csv_processor.get_data_by_quarter(1)
        if not quarter_data.empty:
            if 'Betrag_Clean' not in quarter_data.columns:
                print("‚ùå Betrag_Clean fehlt in Quartalsdaten")
                return False
            
            quarter_total = quarter_data['Betrag_Clean'].sum()
            print(f"‚úÖ Q1 Summe berechnet: {quarter_total:.2f}")
        else:
            print("‚ö†Ô∏è Keine Daten f√ºr Q1 verf√ºgbar")
        
        # Test 4: Account-Mappings vorbereiten
        account_mappings = {
            "4000": "Mitgliedsbeitr√§ge",
            "4100": "Spenden",
            "6300": "B√ºrokosten", 
            "6400": "Miete",
            "8100": "Veranstaltungskosten"
        }
        
        # Test 5: BWA-Zusammenfassung erstellen
        if not quarter_data.empty:
            summary = generator._create_quarter_summary(quarter_data, account_mappings)
            if summary:
                print(f"‚úÖ BWA-Zusammenfassung erstellt: {len(summary)} Gruppen")
                
                # Pr√ºfe ob alle Betr√§ge g√ºltig sind
                for group, amount in summary.items():
                    if not isinstance(amount, (int, float)):
                        print(f"‚ùå Ung√ºltiger Betrag in Gruppe {group}: {amount}")
                        return False
                print("‚úÖ Alle Betr√§ge in Zusammenfassung sind g√ºltig")
            else:
                print("‚ùå BWA-Zusammenfassung konnte nicht erstellt werden")
                return False
        
        # Test 6: Vollst√§ndige PDF-Generierung
        output_pdf = file_manager.get_temp_file_path('test_output.pdf')
        
        print("üîÑ Generiere komplettes PDF...")
        success = generator.generate_bwa_pdf(output_pdf, csv_processor, account_mappings)
        
        if success and os.path.exists(output_pdf):
            file_size = os.path.getsize(output_pdf)
            print(f"‚úÖ PDF erfolgreich erstellt!")
            print(f"   üìÑ Gr√∂√üe: {file_size:,} Bytes")
            
            # Test 7: PDF-Inhalt validieren (falls m√∂glich)
            if file_size > 1000:  # Mindestgr√∂√üe f√ºr g√ºltiges PDF
                print("‚úÖ PDF hat realistische Gr√∂√üe")
            else:
                print("‚ö†Ô∏è PDF sehr klein - m√∂glicherweise leer")
                
        else:
            print("‚ùå PDF-Generierung fehlgeschlagen")
            return False
        
        return True
        
    except Exception as e:
        print(f"‚ùå Fehler beim PDF-Export-Test: {e}")
        import traceback
        print("\nüîç Vollst√§ndiger Traceback:")
        traceback.print_exc()
        return False


def main():
    """Hauptfunktion f√ºr alle PDF-Export-Tests"""
    print("üöÄ BWA-PDF-Export Tests")
    print("=" * 50)
    
    # QApplication f√ºr GUI-Tests
    app = QApplication(sys.argv)
    
    try:
        # Test 1: Spalten-Konsistenz
        success1 = test_pdf_export_consistency()
        
        print("\n" + "=" * 30)
        
        # Test 2: Deckblatt mit Organisationsdaten
        success2 = test_pdf_cover_page_with_organization()
        
        print("\n" + "=" * 50)
        print("üìä Test-Zusammenfassung:")
        print(f"   PDF-Export (Konsistenz): {'‚úÖ' if success1 else '‚ùå'}")
        print(f"   PDF-Deckblatt (Organisation): {'‚úÖ' if success2 else '‚ùå'}")
        
        overall_success = success1 and success2
        
        if overall_success:
            print("\nüéâ Alle PDF-Export-Tests erfolgreich!")
            return True
        else:
            print("\nüí• Ein oder mehrere PDF-Export-Tests fehlgeschlagen!")
            return False
            
    finally:
        app.quit()


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)